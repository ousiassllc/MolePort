# MolePort 機能要件

## 概要

MolePort は、SSH ポートフォワーディングを視覚的に管理する Go 製 TUI アプリケーションである。
`~/.ssh/config` からホスト情報を読み込み、ポート転送の設定・接続・切断をダッシュボード上で直感的に操作できる。

## ユースケース

### UC-1: SSH ホスト一覧の表示

- **アクター**: ユーザー
- **概要**: `~/.ssh/config`（Include ディレクティブ含む）からホスト情報を読み込み、一覧表示する
- **事前条件**: `~/.ssh/config` が存在する
- **基本フロー**:
  1. MolePort を起動する
  2. SSH config を解析し、定義済みホストを取得する
  3. ダッシュボード上部にホスト一覧を表示する
- **表示情報**: ホスト名、HostName（実アドレス）、Port、User、接続状態

### UC-2: ポートフォワーディングの追加

- **アクター**: ユーザー
- **概要**: 対話プロンプトを通じて新しいポート転送ルールを追加する
- **基本フロー**:
  1. コマンド入力欄で `add` を入力する
  2. プロンプトに従い、対象ホスト・転送種別（L/R/D）・ポート情報を入力する
  3. 設定が検証され、転送ルールが登録される
  4. 自動的に接続を開始する
- **代替フロー**:
  - ポート競合がある場合、エラーメッセージを表示し別のポートを提案する

### UC-3: ポートフォワーディングの接続・切断

- **アクター**: ユーザー
- **概要**: 登録済みの転送ルールに対して接続・切断を操作する
- **基本フロー**:
  1. ダッシュボードで転送ルールを選択する
  2. 接続中であれば切断、停止中であれば接続する
- **キーボード操作**: Enter キーでトグル、`d` キーで切断

### UC-4: 接続状態のリアルタイム監視

- **アクター**: ユーザー
- **概要**: アクティブな転送の状態をリアルタイムで表示する
- **表示情報**:
  - 転送種別（Local / Remote / Dynamic）
  - ローカルポート ← → リモートホスト:ポート の視覚的表示
  - 接続状態（接続中 / 停止 / エラー / 再接続中）
  - 接続時間（稼働時間）
  - 転送データ量（送信/受信）
  - エラー状態の詳細
  - 再接続回数

### UC-5: 自動再接続

- **アクター**: システム
- **概要**: SSH 接続が切断された場合に自動でリトライする
- **基本フロー**:
  1. 接続切断を検知する
  2. 状態を「再接続中」に更新し、ダッシュボードに表示する
  3. 指数バックオフでリトライする（1s, 2s, 4s, ... 最大 60s）
  4. 再接続成功時、状態を「接続中」に戻す
- **代替フロー**:
  - 最大リトライ回数（設定可能）に達した場合、状態を「エラー」にしユーザーに通知する

### UC-6: セッション復元

- **アクター**: システム
- **概要**: MolePort 起動時に前回のアクティブな転送を自動復元する
- **基本フロー**:
  1. 起動時に `~/.config/moleport/state.yaml` から前回の状態を読み込む
  2. アクティブだった転送ルールを順次再接続する
  3. 復元結果をダッシュボードに表示する

### UC-7: 設定の永続化と変更

- **アクター**: ユーザー
- **概要**: 対話プロンプトを通じて MolePort の設定を変更する
- **設定項目**:
  - デフォルトの再接続回数上限
  - 再接続のバックオフ設定
  - SSH config のパス
  - 自動復元の有効/無効
- **保存先**: `~/.config/moleport/config.yaml`

### UC-8: 転送ルールの削除

- **アクター**: ユーザー
- **概要**: 登録済みの転送ルールを削除する
- **基本フロー**:
  1. `delete` コマンドまたは `x` キーで対象を選択する
  2. 確認プロンプトを表示する
  3. 確認後、転送を停止しルールを削除する

## 機能一覧

| ID | 機能名 | 説明 | 優先度 |
|----|--------|------|--------|
| F-01 | SSH config 解析 | `~/.ssh/config` + Include ディレクティブを解析しホスト一覧を取得 | 必須 |
| F-02 | ローカル転送 (-L) | ローカルポート → リモートホスト:ポート の転送を管理 | 必須 |
| F-03 | リモート転送 (-R) | リモートポート → ローカルホスト:ポート の逆方向転送を管理 | 必須 |
| F-04 | ダイナミック転送 (-D) | SOCKS プロキシとしてのダイナミック転送を管理 | 必須 |
| F-05 | ダッシュボード表示 | ホスト一覧・転送状況・コマンド入力の3ペイン構成 | 必須 |
| F-06 | 対話プロンプト | コマンド入力による設定変更・操作 | 必須 |
| F-07 | 接続メトリクス | 接続時間、転送データ量、エラー状態、再接続回数の表示 | 必須 |
| F-08 | 自動再接続 | 接続切断時の指数バックオフによる自動リトライ | 必須 |
| F-09 | セッション復元 | 起動時に前回のアクティブ転送を自動復元 | 必須 |
| F-10 | 設定永続化 | YAML ファイルへの設定保存・読み込み | 必須 |
| F-11 | 転送ルール削除 | 不要な転送ルールの削除（確認付き） | 必須 |
| F-12 | キーボードショートカット | Enter でトグル、j/k で移動、d で切断、x で削除、/ でコマンド入力、Esc でキャンセル、Ctrl+C で終了 | 必須 |
| F-13 | SSH config 再読み込み | SSH config の変更を実行中に反映する | 必須 |

## 画面構成

### メイン画面（ダッシュボード）

```
┌─────────────────────────────────────────────────────────────────┐
│  MolePort v0.1.0                                    [?] Help    │
├─────────────────────────────────────────────────────────────────┤
│  SSH Hosts                                                      │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ ● prod-server    192.168.1.10    user@22    ⬤ 2 active    │  │
│  │ ○ staging        10.0.0.5        deploy@22  ○ 0 active    │  │
│  │ ○ dev-db         172.16.0.3      admin@5432 ○ 0 active    │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│  Port Forwards: prod-server                                     │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ Type │ Local        │       │ Remote          │ Status    │  │
│  │──────│──────────────│───────│─────────────────│───────────│  │
│  │  L   │ :8080        │  ───► │ localhost:80    │ ⬤ Active  │  │
│  │      │              │       │                 │ 2h 15m    │  │
│  │      │              │       │                 │ ↑1.2MB    │  │
│  │──────│──────────────│───────│─────────────────│───────────│  │
│  │  L   │ :5432        │  ───► │ localhost:5432  │ ⬤ Active  │  │
│  │      │              │       │                 │ 45m       │  │
│  │      │              │       │                 │ ↑340KB    │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│  > _                                                            │
│  Type 'help' for available commands                             │
└─────────────────────────────────────────────────────────────────┘
```

### 操作フロー

```
起動
 │
 ├── SSH config 読み込み
 ├── 前回状態の復元 (state.yaml)
 ├── アクティブ転送の自動再接続
 │
 ▼
ダッシュボード表示
 │
 ├── ↑↓ / k/j キー: ホスト・ルール選択
 ├── Enter: 転送のトグル（接続/切断）
 ├── Tab: ペイン切り替え
 ├── d: 選択中の転送を切断
 ├── x: 選択中の転送を削除（確認あり）
 ├── /: コマンド入力欄にフォーカス
 ├── Esc: コマンド入力キャンセル・フォーカス解除
 ├── ?: ヘルプ表示
 ├── Ctrl+C: 終了
 │
 ├── コマンド入力:
 │   ├── add      → 転送追加の対話プロンプト
 │   ├── delete   → 転送削除の対話プロンプト
 │   ├── connect  → 停止中の転送を接続
 │   ├── disconnect → アクティブな転送を切断
 │   ├── list     → 全ホスト・全転送ルールの一覧表示
 │   ├── status   → 全転送の状態サマリー
 │   ├── config   → 設定変更の対話プロンプト
 │   ├── reload   → SSH config 再読み込み
 │   ├── help     → コマンドヘルプ
 │   └── quit     → 終了（転送は状態保存後に停止）
 │
 ▼
終了
 ├── アクティブ転送の状態を state.yaml に保存
 └── 全 SSH 接続をグレースフルに切断
```

## 改訂履歴

| 版 | 日付 | 変更内容 | 変更理由 |
|---|------|---------|---------|
| 1.0 | 2026-02-10 | 初版作成 | — |
| 1.1 | 2026-02-10 | 設定ファイルのパスを `~/.config/moleport/` に統一 | ユーザー要望 |
| 1.2 | 2026-02-10 | コマンド・キーバインド・機能一覧を整合性チェック結果に基づき補完 | 整合性チェック |
