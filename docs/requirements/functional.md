# MolePort 機能要件

## 概要

MolePort は、SSH ポートフォワーディングを管理する Go 製ツールである。
バックグラウンドデーモンが SSH 接続とポートフォワーディングを永続管理し、CLI サブコマンドおよび TUI ダッシュボードから操作する。
`~/.ssh/config` からホスト情報を読み込み、ポート転送の設定・接続・切断を直感的に行える。

バイナリ名は `moleport` とする。

## ユースケース

### UC-1: デーモンの起動

- **アクター**: ユーザー
- **概要**: バックグラウンドデーモンを起動し、SSH 接続管理を開始する
- **基本フロー**:
  1. `moleport daemon start` を実行する
  2. 既存デーモンの稼働確認（PID ファイル + ソケット疎通）
  3. デーモンが存在しなければ、プロセスを自己フォークしてバックグラウンド化
  4. PID ファイル・Unix ソケットを作成
  5. config.yaml を読み込み、state.yaml からセッションを復元
  6. auto_connect ルールの自動接続を開始
  7. 「デーモンを起動しました (PID: xxxx)」と表示
- **代替フロー**:
  - デーモンが既に稼働中の場合: 「デーモンは既に稼働中です (PID: xxxx)」と表示

### UC-2: デーモンの停止

- **アクター**: ユーザー
- **概要**: バックグラウンドデーモンを停止する
- **基本フロー**:
  1. `moleport daemon stop` を実行する
  2. デーモンに shutdown リクエストを送信
  3. デーモンが全接続をグレースフルに切断し、状態を保存
  4. 「デーモンを停止しました」と表示
- **代替フロー**:
  - デーモンが稼働していない場合: 「デーモンは稼働していません」と表示

### UC-3: SSH ホスト一覧の表示

- **アクター**: ユーザー
- **概要**: `~/.ssh/config`（Include ディレクティブ含む）からホスト情報を読み込み、一覧表示する
- **CLI**: `moleport list`
- **TUI**: ダッシュボード上部に常時表示
- **表示情報**: ホスト名、HostName（実アドレス）、Port、User、接続状態、アクティブ転送数

### UC-4: SSH ホストへの接続

- **アクター**: ユーザー
- **概要**: 指定ホストに SSH 接続し、auto_connect ルールの転送を開始する
- **CLI**: `moleport connect <host>`
- **TUI**: ホスト一覧で Enter キー
- **基本フロー**:
  1. デーモンに ssh.connect リクエストを送信
  2. デーモンが SSH 接続を確立
  3. 当該ホストの auto_connect ルールのフォワーディングを自動開始
  4. 結果を表示

### UC-5: ポートフォワーディングの追加

- **アクター**: ユーザー
- **概要**: 新しいポート転送ルールを追加する
- **CLI**: `moleport add`（対話形式）
- **TUI**: コマンド入力欄で `add`
- **基本フロー**:
  1. 対話プロンプトで、対象ホスト・転送種別（L/R/D）・ポート情報を入力
  2. デーモンに forward.add リクエストを送信
  3. 設定が検証され、転送ルールが登録される
  4. 自動的にフォワーディングを開始する
- **代替フロー**:
  - ポート競合がある場合、エラーメッセージを表示し別のポートを提案する

### UC-6: ポートフォワーディングの開始・停止

- **アクター**: ユーザー
- **概要**: 登録済みの転送ルールを個別に開始・停止する
- **CLI**: `moleport start <name>` / `moleport stop <name>`
- **TUI**: 転送一覧で Enter キーでトグル、`d` キーで停止

### UC-7: 接続状態のリアルタイム監視

- **アクター**: ユーザー
- **概要**: アクティブな転送の状態をリアルタイムで監視する
- **CLI**: `moleport status`（スナップショット）
- **TUI**: ダッシュボードにリアルタイム表示（イベントサブスクリプション経由）
- **表示情報**:
  - 転送種別（Local / Remote / Dynamic）
  - ローカルポート ← → リモートホスト:ポート の視覚的表示
  - 接続状態（接続中 / 停止 / エラー / 再接続中）
  - 接続時間（稼働時間）
  - 転送データ量（送信/受信）
  - エラー状態の詳細
  - 再接続回数

### UC-8: 自動再接続

- **アクター**: システム（デーモン）
- **概要**: SSH 接続が切断された場合に自動でリトライする
- **基本フロー**:
  1. デーモンが接続切断を検知する
  2. 状態を「再接続中」に更新し、サブスクライブ中のクライアントに通知
  3. 指数バックオフでリトライする（1s, 2s, 4s, ... 最大 60s）
  4. 再接続成功時、ポートフォワーディングを復元し「接続中」に戻す
- **代替フロー**:
  - 最大リトライ回数に達した場合、状態を「エラー」にし通知する

### UC-9: セッション復元

- **アクター**: システム（デーモン）
- **概要**: デーモン起動時に前回のアクティブな転送を自動復元する
- **基本フロー**:
  1. デーモン起動時に `~/.config/moleport/state.yaml` から前回の状態を読み込む
  2. アクティブだった転送ルールを順次再接続する

### UC-10: 設定の永続化と変更

- **アクター**: ユーザー
- **概要**: MolePort の設定を変更する
- **CLI**: `moleport config`（対話形式）
- **TUI**: コマンド入力欄で `config`
- **設定項目**:
  - デフォルトの再接続回数上限
  - 再接続のバックオフ設定
  - SSH config のパス
  - 自動復元の有効/無効
- **保存先**: `~/.config/moleport/config.yaml`

### UC-11: 転送ルールの削除

- **アクター**: ユーザー
- **概要**: 登録済みの転送ルールを削除する
- **CLI**: `moleport delete <name>`
- **TUI**: コマンド入力欄で `delete` または `x` キー
- **基本フロー**:
  1. 確認プロンプトを表示する
  2. 確認後、転送を停止しルールを削除する

### UC-12: TUI ダッシュボードの起動

- **アクター**: ユーザー
- **概要**: デーモンに接続し、リアルタイムダッシュボードを表示する
- **CLI**: `moleport tui`
- **基本フロー**:
  1. デーモンに IPC 接続する
  2. events.subscribe でイベントストリームを開始
  3. ダッシュボードを表示
  4. TUI 終了時にサブスクリプションを解除し、IPC 切断
  5. デーモンとポートフォワーディングはそのまま継続

## 機能一覧

| ID | 機能名 | 説明 | 優先度 |
|----|--------|------|--------|
| F-01 | SSH config 解析 | `~/.ssh/config` + Include ディレクティブを解析しホスト一覧を取得 | 必須 |
| F-02 | ローカル転送 (-L) | ローカルポート → リモートホスト:ポート の転送を管理 | 必須 |
| F-03 | リモート転送 (-R) | リモートポート → ローカルホスト:ポート の逆方向転送を管理 | 必須 |
| F-04 | ダイナミック転送 (-D) | SOCKS プロキシとしてのダイナミック転送を管理 | 必須 |
| F-05 | デーモン管理 | バックグラウンドデーモンの起動・停止・状態確認 | 必須 |
| F-06 | IPC 通信 | Unix ドメインソケット上の JSON-RPC 2.0 によるクライアント通信 | 必須 |
| F-07 | CLI サブコマンド | サブコマンド形式での全操作（daemon/connect/disconnect/add/delete/start/stop/list/status/config/reload/tui/help/version） | 必須 |
| F-08 | TUI ダッシュボード | デーモンに接続してリアルタイム表示するクライアント | 必須 |
| F-09 | 対話プロンプト | CLI/TUI でのインタラクティブな操作入力 | 必須 |
| F-10 | 接続メトリクス | 接続時間、転送データ量、エラー状態、再接続回数の表示 | 必須 |
| F-11 | イベントサブスクリプション | TUI 向けリアルタイムイベント配信（サーバープッシュ） | 必須 |
| F-12 | 自動再接続 | 接続切断時の指数バックオフによる自動リトライ | 必須 |
| F-13 | セッション復元 | デーモン起動時に前回のアクティブ転送を自動復元 | 必須 |
| F-14 | 設定永続化 | YAML ファイルへの設定保存・読み込み | 必須 |
| F-15 | 転送ルール削除 | 不要な転送ルールの削除（確認付き） | 必須 |
| F-16 | キーボードショートカット | TUI でのキーボード操作 | 必須 |
| F-17 | SSH config 再読み込み | SSH config の変更をデーモンに反映する | 必須 |

## CLI サブコマンド体系

### 概要

```
moleport <subcommand> [options] [arguments]
```

### サブコマンド一覧

| サブコマンド | 引数 | 説明 |
|------------|------|------|
| `daemon start` | — | デーモンをバックグラウンドで起動 |
| `daemon stop` | — | デーモンを停止 |
| `daemon status` | — | デーモンの稼働状態を表示 |
| `connect` | `<host>` | SSH ホストに接続（auto_connect ルールも開始） |
| `disconnect` | `<host>` | SSH ホストを切断（全転送も停止） |
| `add` | — | 転送ルールを対話形式で追加 |
| `delete` | `<name>` | 転送ルールを削除 |
| `start` | `<name>` | 転送ルールのフォワーディングを開始 |
| `stop` | `<name>` | 転送ルールのフォワーディングを停止 |
| `list` | `[--host <host>]` | ホスト・転送ルールの一覧を表示 |
| `status` | — | 全体の接続状態サマリーを表示 |
| `config` | — | 設定を対話形式で変更 |
| `reload` | — | SSH config を再読み込み |
| `tui` | — | TUI ダッシュボードを起動 |
| `help` | `[<subcommand>]` | ヘルプを表示 |
| `version` | — | バージョン情報を表示 |

## TUI 画面構成

### メイン画面（ダッシュボード）

```
┌─────────────────────────────────────────────────────────────────┐
│  MolePort v0.1.0                            ⬤ Daemon Connected  │
├─────────────────────────────────────────────────────────────────┤
│  SSH Hosts                                                      │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ ● prod-server    192.168.1.10    user@22    ⬤ 2 active    │  │
│  │ ○ staging        10.0.0.5        deploy@22  ○ 0 active    │  │
│  │ ○ dev-db         172.16.0.3      admin@5432 ○ 0 active    │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│  Port Forwards: prod-server                                     │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ Type │ Local        │       │ Remote          │ Status    │  │
│  │──────│──────────────│───────│─────────────────│───────────│  │
│  │  L   │ :8080        │  ───► │ localhost:80    │ ⬤ Active  │  │
│  │      │              │       │                 │ 2h 15m    │  │
│  │      │              │       │                 │ ↑1.2MB    │  │
│  │──────│──────────────│───────│─────────────────│───────────│  │
│  │  L   │ :5432        │  ───► │ localhost:5432  │ ⬤ Active  │  │
│  │      │              │       │                 │ 45m       │  │
│  │      │              │       │                 │ ↑340KB    │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│  > _                                                            │
│  Type 'help' for available commands                             │
└─────────────────────────────────────────────────────────────────┘
```

**変更点（v1 → v2）**:
- ヘッダーにデーモン接続状態を表示（`⬤ Daemon Connected` / `○ Disconnected`）
- TUI 終了時はデーモン接続を切断するのみ（ポートフォワーディングは継続）

### TUI 内コマンド

TUI 内のコマンド入力機能は従来通り維持する。入力されたコマンドは内部的に IPC 経由でデーモンに送信される。

| コマンド | 短縮形 | 説明 |
|---------|--------|------|
| `add` | `a` | 新しいポートフォワーディングルールを追加する |
| `delete` | `rm` | ポートフォワーディングルールを削除する |
| `connect` | `c` | SSH ホストに接続する |
| `disconnect` | `dc` | SSH ホストを切断する |
| `start` | — | 転送ルールのフォワーディングを開始する |
| `stop` | — | 転送ルールのフォワーディングを停止する |
| `list` | `ls` | 全ホスト・全転送ルールの一覧を表示する |
| `status` | `st` | 接続状態のサマリーを表示する |
| `config` | `cfg` | 設定を変更する |
| `reload` | — | SSH config を再読み込みする |
| `help` | `?` | コマンドヘルプを表示する |
| `quit` | `q` | TUI を終了する（デーモンは継続） |

### キーバインド

| キー | コンテキスト | 動作 |
|------|-----------|------|
| `↑` / `k` | ホスト一覧 / 転送一覧 | 上の項目を選択 |
| `↓` / `j` | ホスト一覧 / 転送一覧 | 下の項目を選択 |
| `Enter` | ホスト一覧 | 選択中のホストに SSH 接続 |
| `Enter` | 転送一覧 | 選択中の転送をトグル（開始/停止） |
| `Tab` | 全体 | ペイン間のフォーカス移動 |
| `d` | 転送一覧 | 選択中の転送を停止 |
| `x` | 転送一覧 | 選択中の転送を削除（確認あり） |
| `?` | 全体 | ヘルプ表示 |
| `/` | 全体 | コマンド入力欄にフォーカス |
| `Esc` | コマンド入力 | コマンド入力をキャンセル・フォーカス解除 |
| `Ctrl+C` | 全体 | TUI を終了（デーモンは継続） |

### 操作フロー

```
moleport daemon start
 │
 ├── config.yaml 読み込み
 ├── state.yaml からセッション復元
 ├── auto_connect ルールの自動接続
 ├── Unix ソケット Listen 開始
 │
 ▼
デーモン常駐（バックグラウンド）
 │
 ├── CLI からの操作:
 │   ├── moleport connect <host>   → SSH 接続 + auto_connect 転送開始
 │   ├── moleport disconnect <host> → SSH 切断 + 全転送停止
 │   ├── moleport add              → 転送ルール追加（対話形式）
 │   ├── moleport delete <name>    → 転送ルール削除
 │   ├── moleport start <name>     → 転送開始
 │   ├── moleport stop <name>      → 転送停止
 │   ├── moleport list             → 一覧表示
 │   ├── moleport status           → 状態サマリー
 │   └── moleport reload           → SSH config 再読み込み
 │
 ├── TUI からの操作:
 │   ├── moleport tui              → ダッシュボード起動
 │   ├── イベントサブスクリプション → リアルタイム更新
 │   └── TUI 終了 → デーモン接続切断のみ（転送は継続）
 │
 ▼
moleport daemon stop
 ├── 全転送の状態を state.yaml に保存
 ├── 全ポートフォワーディング停止
 └── 全 SSH 接続をグレースフルに切断
```

## 改訂履歴

| 版 | 日付 | 変更内容 | 変更理由 |
|---|------|---------|---------|
| 1.0 | 2026-02-10 | 初版作成 | — |
| 1.1 | 2026-02-10 | 設定ファイルのパスを `~/.config/moleport/` に統一 | ユーザー要望 |
| 1.2 | 2026-02-10 | コマンド・キーバインド・機能一覧を整合性チェック結果に基づき補完 | 整合性チェック |
| 2.0 | 2026-02-11 | デーモン化対応: CLI サブコマンド体系追加、ユースケースをデーモン/クライアント構成に改訂 | デーモン化対応 |
