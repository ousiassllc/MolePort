# MolePort 非機能要件

## 概要

MolePort の性能、セキュリティ、可用性、運用性に関する非機能要件を定義する。

## 性能要件

### NFR-01: 起動時間

- **要件**: 起動から TUI 表示まで 1 秒以内
- **条件**: SSH config のホスト数が 50 件以下の場合
- **備考**: SSH config の解析とセッション復元は非同期で行い、UI 表示を優先する

### NFR-02: SSH 接続の確立

- **要件**: 接続開始からポートフォワーディング確立まで 10 秒以内
- **条件**: ネットワーク遅延が正常な環境（RTT 200ms 以下）
- **備考**: 接続処理はバックグラウンドで実行し、UI をブロックしない

### NFR-03: リアルタイム更新

- **要件**: メトリクス（接続時間、データ量）の表示更新間隔は 1 秒以内
- **備考**: 状態変化（接続/切断/エラー）は即座に反映する

### NFR-04: 同時接続数

- **要件**: 最低 20 件の同時ポートフォワーディングを安定して管理できること
- **備考**: 各接続は独立した goroutine で管理する

### NFR-05: メモリ使用量

- **要件**: アイドル時のメモリ使用量は 50MB 以下
- **備考**: 接続数に比例した緩やかな増加は許容する

## セキュリティ要件

### NFR-06: 認証情報の取り扱い

- **要件**: パスフレーズやパスワードをディスクに保存しない
- **備考**: メモリ上での保持も最小限にし、使用後は速やかにクリアする

### NFR-07: SSH config の読み取り

- **要件**: SSH config ファイルの読み取りはユーザー権限で行い、他ユーザーのファイルにアクセスしない
- **備考**: ファイルパーミッションが不適切な場合は警告を表示する

### NFR-08: 設定ファイルの保護

- **要件**: `~/.config/moleport/` 配下のファイルはパーミッション `0600`（所有者のみ読み書き可）で作成する
- **備考**: 既存ファイルのパーミッションが緩い場合は警告を表示する

### NFR-09: 通信の安全性

- **要件**: SSH プロトコルの暗号化を利用し、平文通信は行わない
- **備考**: HostKeyCallback を適切に設定し、known_hosts による検証を行う

## 可用性要件

### NFR-10: 自動再接続

- **要件**: 接続断を検知後、指数バックオフ（1s, 2s, 4s, ... 最大 60s）で自動リトライする
- **上限**: デフォルト最大 10 回。設定で変更可能
- **備考**: 再接続中もダッシュボードは操作可能であること

### NFR-11: グレースフルシャットダウン

- **要件**: 終了時に全 SSH 接続をグレースフルに切断し、状態を保存する
- **タイムアウト**: 接続切断は 5 秒以内に完了すること。タイムアウト時は強制切断する
- **備考**: SIGINT / SIGTERM の両方をハンドリングする

### NFR-12: エラー耐性

- **要件**: 個別の SSH 接続エラーがアプリケーション全体をクラッシュさせないこと
- **備考**: エラーはダッシュボードに表示し、他の接続には影響を与えない

## 運用性要件

### NFR-13: 対応 OS

- **要件**: Linux、macOS で動作すること
- **備考**: Go のクロスコンパイルを活用し、シングルバイナリで配布する

### NFR-14: 依存関係

- **要件**: 外部コマンドへの依存を持たないこと（ssh コマンド不要）
- **備考**: Go の SSH ライブラリ（golang.org/x/crypto/ssh）で完結する

### NFR-15: ログ出力

- **要件**: デバッグ用のログをファイルに出力する機能を持つこと
- **出力先**: `~/.config/moleport/moleport.log`
- **備考**: ログレベル（debug / info / warn / error）を設定で切り替え可能

### NFR-16: ターミナル互換性

- **要件**: 256 色以上をサポートするターミナルで正常に表示できること
- **備考**: True Color 対応ターミナルでの表示を推奨。最低限 16 色でも機能すること

## 改訂履歴

| 版 | 日付 | 変更内容 | 変更理由 |
|---|------|---------|---------|
| 1.0 | 2026-02-10 | 初版作成 | — |
| 1.1 | 2026-02-10 | 設定ファイルのパスを `~/.config/moleport/` に統一 | ユーザー要望 |
