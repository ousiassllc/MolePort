# MolePort 非機能要件

## 概要

MolePort の性能、セキュリティ、可用性、運用性に関する非機能要件を定義する。

## 性能要件

### NFR-01: デーモン起動時間

- **要件**: `moleport daemon start` からデーモンがリクエスト受付可能になるまで 1 秒以内
- **条件**: SSH config のホスト数が 50 件以下の場合
- **備考**: セッション復元・auto_connect の接続はバックグラウンドで非同期実行し、ソケット Listen を優先する

### NFR-02: CLI レスポンス時間

- **要件**: CLI コマンド発行からレスポンス表示まで 500ms 以内（ネットワーク操作を除く）
- **備考**: IPC 通信のオーバーヘッドを最小限にする。Unix ドメインソケットはローカル通信のため低遅延

### NFR-03: SSH 接続の確立

- **要件**: 接続開始からポートフォワーディング確立まで 10 秒以内
- **条件**: ネットワーク遅延が正常な環境（RTT 200ms 以下）
- **備考**: 接続処理はデーモン内でバックグラウンド実行し、CLI/TUI をブロックしない

### NFR-04: リアルタイム更新

- **要件**: メトリクス（接続時間、データ量）の TUI 表示更新間隔は 1 秒以内
- **備考**: 状態変化（接続/切断/エラー）はイベントサブスクリプションで即座に反映する

### NFR-05: 同時接続数

- **要件**: 最低 20 件の同時ポートフォワーディングを安定して管理できること
- **備考**: 各接続は独立した goroutine で管理する

### NFR-06: メモリ使用量

- **要件**: デーモンのアイドル時メモリ使用量は 50MB 以下
- **備考**: 接続数に比例した緩やかな増加は許容する。長時間稼働でのメモリリークがないこと

### NFR-07: 同時クライアント

- **要件**: 同時に 5 クライアント以上の IPC 接続を安定して処理できること
- **備考**: 各クライアント接続は独立した goroutine で処理する

## セキュリティ要件

### NFR-08: 認証情報の取り扱い

- **要件**: パスフレーズやパスワードをディスクに保存しない
- **備考**: メモリ上での保持も最小限にし、使用後は速やかにクリアする

### NFR-09: SSH config の読み取り

- **要件**: SSH config ファイルの読み取りはユーザー権限で行い、他ユーザーのファイルにアクセスしない
- **備考**: ファイルパーミッションが不適切な場合は警告を表示する

### NFR-10: 設定ファイルの保護

- **要件**: `~/.config/moleport/` 配下のファイルはパーミッション `0600`（所有者のみ読み書き可）で作成する
- **備考**: 既存ファイルのパーミッションが緩い場合は警告を表示する

### NFR-11: 通信の安全性

- **要件**: SSH プロトコルの暗号化を利用し、平文通信は行わない
- **備考**: HostKeyCallback を適切に設定し、known_hosts による検証を行う

### NFR-12: Unix ソケットの保護

- **要件**: Unix ドメインソケットのパーミッションを `0600`（所有者のみアクセス可）に設定する
- **備考**: 他ユーザーからの不正な IPC 接続を防止する

### NFR-13: PID ファイルの安全性

- **要件**: PID ファイルの作成時に `flock` で排他ロックを取得し、競合起動を防止する
- **備考**: stale PID ファイルの検出と自動クリーンアップを行う

## 可用性要件

### NFR-14: デーモンの安定稼働

- **要件**: デーモンは長時間（数日〜数週間）の連続稼働に耐えること
- **備考**: goroutine リーク、メモリリーク、ファイルディスクリプタリークがないこと

### NFR-15: 自動再接続

- **要件**: 接続断を検知後、指数バックオフ（1s, 2s, 4s, ... 最大 60s）で自動リトライする
- **上限**: デフォルト最大 10 回。設定で変更可能
- **備考**: 再接続中も他の接続・クライアント通信に影響しないこと

### NFR-16: グレースフルシャットダウン

- **要件**: `moleport daemon stop` または SIGTERM/SIGINT で全接続をグレースフルに切断し、状態を保存する
- **タイムアウト**: 接続切断は 5 秒以内に完了すること。タイムアウト時は強制切断する
- **備考**: クライアントへの shutdown 通知を送信してから接続を切断する

### NFR-17: エラー耐性

- **要件**: 個別の SSH 接続エラーがデーモン全体をクラッシュさせないこと
- **備考**: エラーはクライアントに通知し、他の接続には影響を与えない

### NFR-18: クライアント切断耐性

- **要件**: CLI/TUI クライアントの異常切断がデーモンの動作に影響しないこと
- **備考**: クライアント切断時はサブスクリプションをクリーンアップする

## 運用性要件

### NFR-19: 対応 OS

- **要件**: Linux、macOS で動作すること
- **備考**: Go のクロスコンパイルを活用し、シングルバイナリで配布する

### NFR-20: 依存関係

- **要件**: 外部コマンドへの依存を持たないこと（ssh コマンド不要）
- **備考**: Go の SSH ライブラリ（golang.org/x/crypto/ssh）で完結する

### NFR-21: ログ出力

- **要件**: デーモンのログをファイルに出力する機能を持つこと
- **出力先**: `~/.config/moleport/moleport.log`
- **備考**: ログレベル（debug / info / warn / error）を設定で切り替え可能。ログローテーションはユーザーの外部ツール（logrotate 等）に委ねる

### NFR-22: ターミナル互換性

- **要件**: TUI は 256 色以上をサポートするターミナルで正常に表示できること
- **備考**: True Color 対応ターミナルでの表示を推奨。最低限 16 色でも機能すること

### NFR-23: バイナリ配布

- **要件**: `moleport` のシングルバイナリを配布すること
- **備考**: `go install` または `make install` で `$(go env GOPATH)/bin` にインストールする

## 改訂履歴

| 版 | 日付 | 変更内容 | 変更理由 |
|---|------|---------|---------|
| 1.0 | 2026-02-10 | 初版作成 | — |
| 1.1 | 2026-02-10 | 設定ファイルのパスを `~/.config/moleport/` に統一 | ユーザー要望 |
| 2.0 | 2026-02-11 | デーモン化対応: デーモン安定稼働、IPC セキュリティ、クライアント切断耐性、PID ファイル安全性等を追加 | デーモン化対応 |
